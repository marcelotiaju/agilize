generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id                   String             @id @default(cuid())
  name                 String?
  email                String             @unique
  emailVerified        DateTime?
  image                String?
  cpf                  String             @unique
  phone                String?
  password             String
  validFrom            DateTime
  validTo              DateTime
  historyDays          Int                @default(30)
  canExport            Boolean            @default(false)
  canDelete            Boolean            @default(false)
  // Novas permissões
  canLaunchEntry       Boolean            @default(false)
  canLaunchTithe       Boolean            @default(false)
  canLaunchExpense     Boolean            @default(false)
  canApproveEntry      Boolean            @default(false)
  canApproveTithe      Boolean            @default(false)
  canApproveExpense    Boolean            @default(false)
  canCreate            Boolean            @default(false)
  canEdit              Boolean            @default(false)
  canExclude           Boolean            @default(false)
  canManageUsers       Boolean            @default(false)
  defaultPage          String             @default("/dashboard")
  canManageSummary     Boolean            @default(false)
  canApproveTreasury   Boolean            @default(false)
  canApproveAccountant Boolean            @default(false)
  canApproveDirector   Boolean            @default(false)
  accounts             Account[]
  sessions             Session[]
  congregations        UserCongregation[]
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
}

model Congregation {
  id                     String                @id @default(cuid())
  code                   String                @unique
  name                   String
  regionalName           String?
  // Novos campos
  entradaAccountPlan     String?
  entradaFinancialEntity String?
  entradaPaymentMethod   String?
  dizimoAccountPlan      String?
  dizimoFinancialEntity  String?
  dizimoPaymentMethod    String?
  saidaAccountPlan       String?
  saidaFinancialEntity   String?
  saidaPaymentMethod     String?
  matriculaEnergisa      String?
  matriculaIgua          String?
  users                  UserCongregation[]
  launches               Launch[]
  contributors           Contributor[]
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  CongregationSummary    CongregationSummary[]
}

model UserCongregation {
  id             String       @id @default(cuid())
  userId         String
  congregationId String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  congregation   Congregation @relation(fields: [congregationId], references: [id], onDelete: Cascade)

  @@unique([userId, congregationId])
}

model Launch {
  id               String               @id @default(cuid())
  congregationId   String
  congregation     Congregation         @relation(fields: [congregationId], references: [id], onDelete: Cascade)
  type             LaunchType
  date             DateTime
  talonNumber      String?
  offerValue       Float?
  votesValue       Float?
  ebdValue         Float?
  campaignValue    Float?
  value            Float?
  description      String?
  status           LaunchStatus         @default(NORMAL)
  // exported         Boolean         @default(false)
  // approved         Boolean         @default(false) // Campo para aprovação
  contributorId    String? // Relacionamento com contribuinte
  contributor      Contributor?         @relation(fields: [contributorId], references: [id])
  contributorName  String?
  supplierId       String? // Relacionamento com fornecedor
  supplier         Supplier?            @relation(fields: [supplierId], references: [id])
  supplierName     String?
  classificationId String? // Novo campo para classificação
  classification   Classification?      @relation(fields: [classificationId], references: [id])
  summaryId        String?
  summary          CongregationSummary? @relation(fields: [summaryId], references: [id])
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  //@@unique([congregationId, date, type, status], name: "unique_launch_per_day_type_status")
}

model Contributor {
  id                     String           @id @default(cuid())
  congregationId         String?
  congregation           Congregation?    @relation(fields: [congregationId], references: [id], onDelete: Cascade)
  code                   String           @unique
  name                   String
  cpf                    String?
  ecclesiasticalPosition String?
  tipo                   ContributorType?
  // Novo campo para foto
  photoUrl               String?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  Launch                 Launch[]

  @@unique([congregationId, code, name], name: "unique_contributor_code_name")
}

model Supplier {
  id          String      @id @default(cuid())
  code        String      @unique
  razaoSocial String
  tipoPessoa  PessoaType?
  cpfCnpj     String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  Launch      Launch[]
}

model Classification {
  id          String   @id @default(cuid())
  code        String   @unique
  shortCode   String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Launch      Launch[]
}

model CongregationSummary {
  id                 String       @id @default(cuid())
  congregationId     String
  congregation       Congregation @relation(fields: [congregationId], references: [id], onDelete: Cascade)
  date               DateTime     @default(now())
  startDate          DateTime
  endDate            DateTime
  // Campos de totais
  launchCount        Int          @default(0)
  entryCount         Int          @default(0)
  titheCount         Int          @default(0)
  exitCount          Int          @default(0)
  // Campos de totais por tipo
  entryTotal        Float         @default(0)
  titheTotal        Float         @default(0)
  exitTotal         Float         @default(0)
  // Valores de entrada
  titheValue         Float        @default(0)
  offerValue         Float        @default(0)
  votesValue         Float        @default(0)
  campaignValue      Float        @default(0)
  ebdValue           Float        @default(0)
  // Valores de saída
  exitValue          Float        @default(0)
  // Campos de prestação de contas
  depositValue       Float        @default(0)
  cashValue          Float        @default(0)
  totalValue         Float        @default(0)
  // Aprovações
  treasurerApproved  Boolean      @default(false)
  accountantApproved Boolean      @default(false)
  directorApproved   Boolean      @default(false)
  status             SummaryStatus @default(PENDING)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  Launch             Launch[]

  @@unique([congregationId, startDate, endDate])
}

enum LaunchType {
  ENTRADA
  DIZIMO
  SAIDA
}

enum LaunchStatus {
  NORMAL
  CANCELED
  APPROVED
  EXPORTED
}

enum ContributorType {
  CONGREGADO
  MEMBRO
}

enum PessoaType {
  FISICA
  JURIDICA
}

enum SummaryStatus {
  PENDING
  APPROVED
}
