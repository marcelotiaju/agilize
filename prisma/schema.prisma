generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime @db.DateTime(0)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime @db.DateTime(0)

  @@unique([identifier, token])
}

model User {
  id            String    @id @default(cuid())
  login         String?   @unique
  name          String?
  email         String    @unique
  emailVerified DateTime? @db.DateTime(0)
  image         String?   @db.Text
  phone         String?
  password      String
  validFrom     DateTime  @db.DateTime(0)
  validTo       DateTime  @db.DateTime(0)
  historyDays   Int       @default(30)
  defaultPage   String    @default("/dashboard")

  // relacionamento com Profile (permissões agora centralizadas em Profile)
  profileId String?
  profile   Profile? @relation(fields: [profileId], references: [id])

  accounts      Account[]
  sessions      Session[]
  congregations UserCongregation[]
  createdAt     DateTime           @default(now()) @db.DateTime(0)
  updatedAt     DateTime           @updatedAt @db.DateTime(0)
}

model Profile {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?

  // permissões centralizadas (migradas do User)
  canExport              Boolean @default(false)
  canDelete              Boolean @default(false)
  canLaunchVote          Boolean @default(false)
  canLaunchEbd           Boolean @default(false)
  canLaunchCampaign      Boolean @default(false)
  canLaunchTithe         Boolean @default(false)
  canLaunchExpense       Boolean @default(false)
  canLaunchMission       Boolean @default(false)
  canLaunchCircle        Boolean @default(false)
  canLaunchServiceOffer  Boolean @default(false)
  canLaunchCarneReviver  Boolean @default(false)
  canApproveVote         Boolean @default(false)
  canApproveEbd          Boolean @default(false)
  canApproveCampaign     Boolean @default(false)
  canApproveTithe        Boolean @default(false)
  canApproveExpense      Boolean @default(false)
  canApproveMission      Boolean @default(false)
  canApproveCircle       Boolean @default(false)
  canApproveServiceOffer Boolean @default(false)
  canApproveCarneReviver Boolean @default(false)
  canCreate              Boolean @default(false)
  canEdit                Boolean @default(false)
  canExclude             Boolean @default(false)
  canListSummary         Boolean @default(false)
  canGenerateSummary     Boolean @default(false)
  canApproveTreasury     Boolean @default(false)
  canApproveAccountant   Boolean @default(false)
  canApproveDirector     Boolean @default(false)
  canManageUsers         Boolean @default(false)
  canGenerateReport      Boolean @default(false)
  canDeleteLaunch        Boolean @default(false)
  canImportLaunch        Boolean @default(false)

  users     User[]
  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)
}

model Congregation {
  id                                 String                @id @default(cuid())
  code                               String                @unique
  name                               String
  regionalName                       String?
  // Campos legados de "Entrada->Oferta"
  entradaOfferAccountPlan            String?
  entradaOfferFinancialEntity        String?
  entradaOfferPaymentMethod          String?
  // Novos campos dedicados para "Oferta do Culto" (mantemos legados para compatibilidade)
  entradaEbdAccountPlan              String?
  entradaEbdFinancialEntity          String?
  entradaEbdPaymentMethod            String?
  entradaCampaignAccountPlan         String?
  entradaCampaignFinancialEntity     String?
  entradaCampaignPaymentMethod       String?
  entradaVotesAccountPlan            String?
  entradaVotesFinancialEntity        String?
  entradaVotesPaymentMethod          String?
  entradaCarneReviverAccountPlan     String?
  entradaCarneReviverFinancialEntity String?
  entradaCarneReviverPaymentMethod   String?
  dizimoAccountPlan                  String?
  dizimoFinancialEntity              String?
  dizimoPaymentMethod                String?
  saidaFinancialEntity               String?
  saidaPaymentMethod                 String?
  missionAccountPlan                 String?
  missionFinancialEntity             String?
  missionPaymentMethod               String?
  circleAccountPlan                  String?
  circleFinancialEntity              String?
  circlePaymentMethod                String?
  matriculaEnergisa                  String?
  matriculaIgua                      String?
  users                              UserCongregation[]
  launches                           Launch[]
  contributors                       Contributor[]
  createdAt                          DateTime              @default(now()) @db.DateTime(0)
  updatedAt                          DateTime              @updatedAt @db.DateTime(0)
  CongregationSummary                CongregationSummary[]
}

model UserCongregation {
  id             String       @id @default(cuid())
  userId         String
  congregationId String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  congregation   Congregation @relation(fields: [congregationId], references: [id], onDelete: Cascade)

  @@unique([userId, congregationId])
  @@index([userId])
  @@index([congregationId])
}

model Launch {
  id                   String               @id @default(cuid())
  congregationId       String
  congregation         Congregation         @relation(fields: [congregationId], references: [id], onDelete: Cascade)
  type                 LaunchType
  date                 DateTime             @db.DateTime(0)
  talonNumber          String?
  value                Float?               @default(0)
  description          String?              @db.VarChar(255)
  status               LaunchStatus         @default(NORMAL)
  contributorId        String?
  contributor          Contributor?         @relation(fields: [contributorId], references: [id])
  contributorName      String?
  supplierId           String?
  supplier             Supplier?            @relation(fields: [supplierId], references: [id])
  supplierName         String?
  classificationId     String?
  classification       Classification?      @relation(fields: [classificationId], references: [id])
  summaryId            String?
  summary              CongregationSummary? @relation(fields: [summaryId], references: [id])
  createdAt            DateTime             @default(now()) @db.DateTime(0)
  updatedAt            DateTime             @updatedAt @db.DateTime(0)
  createdBy            String?
  cancelledBy          String?
  cancelledAt          DateTime?
  approvedByTreasury   String?
  approvedAtTreasury   DateTime?
  approvedByAccountant String?
  approvedAtAccountant DateTime?
  approvedByDirector   String?
  approvedAtDirector   DateTime?
  approvedVia          String?              // 'GRID' ou 'SUMMARY' - método de aprovação

  @@index([congregationId])
  @@index([summaryId])
  @@index([contributorId])
  @@index([supplierId])
  @@index([classificationId])
}

model Contributor {
  id                     String           @id @default(cuid())
  congregationId         String?
  congregation           Congregation?    @relation(fields: [congregationId], references: [id], onDelete: Cascade)
  code                   String           @unique
  name                   String
  cpf                    String?
  ecclesiasticalPosition String?
  tipo                   ContributorType?
  photoUrl               String?          @db.Text
  createdAt              DateTime         @default(now()) @db.DateTime(0)
  updatedAt              DateTime         @updatedAt @db.DateTime(0)
  Launch                 Launch[]

  @@unique([congregationId, code, name], name: "unique_contributor_code_name")
  @@index([congregationId])
}

model Supplier {
  id          String      @id @default(cuid())
  code        String      @unique
  razaoSocial String
  tipoPessoa  PessoaType?
  cpfCnpj     String?
  createdAt   DateTime    @default(now()) @db.DateTime(0)
  updatedAt   DateTime    @updatedAt @db.DateTime(0)
  Launch      Launch[]
}

model Classification {
  id          String   @id @default(cuid())
  code        String   @unique
  shortCode   String   @unique
  description String
  createdAt   DateTime @default(now()) @db.DateTime(0)
  updatedAt   DateTime @updatedAt @db.DateTime(0)
  Launch      Launch[]
}

model CongregationSummary {
  id                   String        @id @default(cuid())
  congregationId       String
  congregation         Congregation  @relation(fields: [congregationId], references: [id], onDelete: Cascade)
  date                 DateTime      @default(now()) @db.DateTime(0)
  startDate            DateTime      @db.DateTime(0)
  endDate              DateTime      @db.DateTime(0)
  launchCount          Int           @default(0)
  entryTotal           Float         @default(0)
  titheTotal           Float         @default(0)
  exitTotal            Float         @default(0)
  offerTotal           Float         @default(0)
  votesTotal           Float         @default(0)
  ebdTotal             Float         @default(0)
  campaignTotal        Float         @default(0)
  missionTotal         Float         @default(0)
  circleTotal          Float         @default(0)
  carneReviverTotal    Float         @default(0)
  exitValue            Float         @default(0)
  talonNumber          String?
  depositValue         Float         @default(0)
  cashValue            Float         @default(0)
  totalValue           Float         @default(0)
  summaryType          String?       // PADRAO, MISSAO, CARNE_REVIVER, CIRCULO
  treasurerApproved    Boolean       @default(false)
  accountantApproved   Boolean       @default(false)
  directorApproved     Boolean       @default(false)
  approvedByTreasury   String?
  approvedAtTreasury   DateTime?
  approvedByAccountant String?
  approvedAtAccountant DateTime?
  approvedByDirector   String?
  approvedAtDirector   DateTime?
  status               SummaryStatus @default(PENDING)
  createdBy            String?
  createdAt            DateTime      @default(now()) @db.DateTime(0)
  updatedAt            DateTime      @updatedAt @db.DateTime(0)
  Launch               Launch[]

  //@@unique([congregationId, startDate, endDate])
  //@@index([congregationId])
}

enum LaunchType {
  DIZIMO
  VOTO
  EBD
  CAMPANHA
  OFERTA_CULTO
  MISSAO
  CIRCULO
  ENTRADA
  SAIDA
  CARNE_REVIVER
}

enum LaunchStatus {
  NORMAL
  CANCELED
  APPROVED
  EXPORTED
  IMPORTED
}

enum ContributorType {
  CONGREGADO
  MEMBRO
}

enum PessoaType {
  FISICA
  JURIDICA
}

enum SummaryStatus {
  PENDING
  APPROVED
}
